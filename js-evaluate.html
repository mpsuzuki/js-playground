<html>
  <head>
  </head>
  <body>
    <div>
      <input type="file" id="fileSelector" multiple>
      <input type="button" id="startEvaluate" value="evaluate">
    </div>
    <div>
      <table>
        <tbody>
        </tbody>
      </table>
    </div>
    <script>
      let elmFileSelector = document.getElementById("fileSelector");
      let elmStartEvaluate = document.getElementById("startEvaluate");
      let elmTABLE = document.getElementsByTagName("tbody")[0];
      let progFragments = {};

      let handleFileSelector = function() {

        let srcFiles = elmFileSelector.files;

        if (srcFiles.length > 0) {
          elmFileSelector.disabled = true;

          let promisesForFiles = [];

          for (let i = 0; i < srcFiles.length; i ++) {
            let f = srcFiles[i];
            let key = f.name;
            promisesForFiles.push( f.text().then((val) => {progFragments[ key ] = val}) );
          };

          Promise.all(promisesForFiles).then((val) => {elmFileSelector.disabled = false});
        };
      };

      let wk = new Worker("worker.js");

      let evaluateSingleFragment = function(arrForPrompt, progFragment) {
        let prefixText  = "";
            prefixText += "let arrForPrompt = " + JSON.stringify(arrForPrompt) + ";\n";
            prefixText += "let prompt = function(){ return arrForPrompt.shift(); };\n";
            prefixText += "let arrForAlert = [];\n";
            prefixText += "let alert = function(v){ arrForAlert.push(v)};\n";

        let postfixText  = "";
            postfixText += "let result = {};\n";
            postfixText += "result.prompt = arrForPrompt;\n";
            postfixText += "result.alert = arrForAlert;\n";
            postfixText += "return result;\n";

        let compositeText = prefixText + progFragment + postfixText;

        let result = null;
        let pr = new Promise((resolve, reject) => {
          if (wk == null) {
            wk = new Worker("worker.js");
          };
          let stp = function() {
            wk.terminate();
            wk = null;
            result = {};
            result.error = "timeout";
            resolve(result);
          };
          let brk = setTimeout(stp, 100);
          wk.onmessage = function(evt) {
            clearTimeout(brk);
            result = JSON.parse(evt.data);
            resolve(result);
          };
          wk.postMessage(compositeText);
        });
        return pr;
      };

    
      let enqueEvaluation = function(arrForPrompt, arrToDo) {
        if (arrToDo.length > 0) {
          let q = arrToDo.shift();
          evaluateSingleFragment(arrForPrompt, q.fragment)
          .then((result) => {


            let elmTR = document.createElement("tr");
            elmTABLE.appendChild(elmTR);

            let elmTH = document.createElement("th");
            elmTR.appendChild(elmTH);

            let name_filtered = q.name.replace(/_[0-9]{4}(-[0-9]{2}){5}\.js/, ""); // remove date-time.js suffix
            let txtNAME = document.createTextNode(name_filtered);
            elmTH.appendChild(txtNAME);

            let elmTD = document.createElement("td");
            elmTR.appendChild(elmTD);
            let txtRESULT = null;
            if (result.alert && result.alert.length > 0) {
              txtRESULT = document.createTextNode(result.alert[0]);
            } else {
              txtRESULT = document.createTextNode(result.error);
            };
            elmTD.appendChild(txtRESULT);


            enqueEvaluation(arrForPrompt, arrToDo);
          });
        };
      };


      let evaluateFragments = function() {
        let arrToDo = [];
        for (const [k, v] of Object.entries( progFragments ) ) {
          let q = {};
          q.name = k;
          q.fragment = v;
          arrToDo.push(q);
        };

        enqueEvaluation([1901], arrToDo);
      };

      elmFileSelector.addEventListener("change", handleFileSelector);
      elmStartEvaluate.addEventListener("click", evaluateFragments);
    </script>
  </body>
</html>


